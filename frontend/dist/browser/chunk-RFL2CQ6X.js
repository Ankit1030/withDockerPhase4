import{b as k}from"./chunk-XFWSRHR4.js";import{a as V}from"./chunk-ONPOCEYN.js";import{b as T,d as C,f as I,g as N,h as F,l as O,p as z,q as x,r as L,s as D,t as R,v as G,w as B,x as U}from"./chunk-43DCFWML.js";import{b as A,n as Z}from"./chunk-2GWGYD35.js";import{$ as v,Ac as P,Cb as m,Nb as r,Ob as w,Pb as f,Sa as c,Ta as d,Vb as b,ea as E,hb as M,jb as h,rb as y,sb as u,tb as a,ub as s,vb as _,xc as S}from"./chunk-53WIH66V.js";import"./chunk-6GU5JNHE.js";var W=(l,n)=>n._id;function Y(l,n){if(l&1&&(a(0,"option",6),r(1),s()),l&2){let g=n.$implicit;h("value",g.ccode+" "+g._id),c(),f(" ",g.cname," ")}}function j(l,n){l&1&&(a(0,"div",13),r(1,"please select a country"),s())}function $(l,n){if(l&1&&(a(0,"option",6),r(1),s()),l&2){let g=n.$implicit;h("value",g.city),c(),f(" ",g.city," ")}}var lt=(()=>{let n=class n{constructor(t,e,o,i){this.http=t,this.router=e,this.formBuilder=o,this.getservice=i,this.countries=[],this.update_status=!1,this.selected_country=null,this.buttonName="Add city",this.isAddMode=!0,this.allcities=[],this.showBtn=!1,this.autocompleteCity=null,this.toaster=v(Z)}loadMap(){navigator.geolocation.getCurrentPosition(t=>{let e=t.coords,o={lat:e.latitude,lng:e.longitude};this.place=o,this.map=new google.maps.Map(document.getElementById("map"),{zoom:5,center:o})})}fetchCountries(){this.cityForm.get("mycity").disable(),this.getservice.getcountry({}).subscribe({next:t=>{if(console.log(t),t.data===null){this.countries=[];return}this.countries=t.data,console.warn("ALL COUNTRIES RECEIVED SUCCESS")},error:t=>{console.log("fetchCountries",t),this.toaster.error(t.err.message,"Error"),console.log("GET ALL COUNTRIES ERROR--")},complete:()=>{}})}ngOnInit(){this.cityForm=this.formBuilder.group({country:["",C.required],mycity:["",C.required],city:[""]}),this.map_init(),this.loadMap(),this.fetchCountries(),this.cityForm.get("city").disable()}markFormGroupTouched(t){console.log("markformGroup works-------------------------------------------------"),Object.values(t.controls).forEach(e=>{e.markAsTouched(),e instanceof F&&this.markFormGroupTouched(e)})}toggleButtonMode(){this.isAddMode=!this.isAddMode,this.buttonName=this.isAddMode?"Add city":"Update city"}loadmap(t){this.selected_city_name=null,console.log("place->>",t);let e=t.place_id,o=t.geometry.location.lat(),i=t.geometry.location.lng(),p={lat:o,lng:i};this.geometry_location=p,console.log("searched gemoetry location",this.geometry_location);let q=t.formatted_address;this.selected_city_name=t.formatted_address,console.warn("PLACE>NAME",this.selected_city_name),this.marker&&(this.marker.setMap(null),this.marker=null),this.check_existing({city:this.selected_city_name})}resetMap(){document.getElementById("map")&&(this.polygon&&(this.polygon.setMap(null),this.polygon=null),this.map.setCenter(this.place),this.map.setZoom(5),this.marker.setMap(null),this.drawingManager&&this.drawingManager.setMap(null),this.drawingManager=null,this.geometry_location=null)}onallreadySelectCity(){this.cityForm.get("mycity").setValue(""),this.selected_city_name=this.cityForm.get("city").value,console.log("onallreadySelectCity()",this.cityForm.get("city").value),this.marker&&(this.marker.setMap(null),this.marker=null),this.drawingManager&&this.drawingManager.setMap(null),this.drawingManager=null,this.check_existing({city:this.cityForm.get("city").value})}map_init(){let t=document.getElementById("city"),e={types:["(cities)"]};this.autocompleteCity=new google.maps.places.Autocomplete(t,e),this.autocompleteCity.addListener("place_changed",()=>{let o=this.autocompleteCity.getPlace();if(console.warn("place",o),!o.geometry){console.error("No details available for input: '"+o.name+"'"),this.toaster.error("Please select city from suggestions","Invalid City Input");return}this.cityForm.get("city").setValue(""),this.loadmap(o)})}draw_new_polygon(){console.log("this.drawingManager->>",this.drawingManager),this.map.setZoom(11),this.drawingManager||(console.log("/////////////   ----------- NEW DRAWING MANAGER DRAWN----------------****************************************"),this.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon"]},polygonOptions:{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:4,fillColor:"#000000",fillOpacity:.4,editable:!0,draggable:!0}})),this.drawingManager.setMap(this.map),console.log("this.drawingManager.getDrawingMode()",this.drawingManager.getDrawingMode()),console.log("-----------------------DRAWING AREA----------------"),this.drawingManager.setMap(this.map),google.maps.event.addListener(this.drawingManager,"overlaycomplete",t=>{if(t.type==google.maps.drawing.OverlayType.POLYGON){if(this.polygon&&(console.log("this.polygon",this.polygon),this.polygon.setMap(null),this.polygon=null),this.polygon=t.overlay,console.log("event.overlay - > ",this.polygon),this.selected_city_zone=t.overlay.getPath().getArray(),google.maps.event.addListener(t.overlay.getPath(),"set_at",()=>{console.log("SET AT "),this.onPolygonChanged(t.overlay,this.selected_city_zone)}),google.maps.event.addListener(t.overlay.getPath(),"insert_at",()=>{console.log("INSERT AT "),this.onPolygonChanged(t.overlay,this.selected_city_zone)}),google.maps.event.addListener(t.overlay.getPath(),"remove_at",()=>{console.log("REMOVE AT "),this.onPolygonChanged(t.overlay,this.selected_city_zone)}),this.isMarkerInsidePolygon(this.geometry_location,this.selected_city_zone)===!1)return alert("the zone is outside the City "),null;this.polygon.setMap(this.map),console.log("----------------------------------------------------"),console.log(this.polygon),console.log("----------------------------------------------------")}})}serializePolygon(t){return t.getArray().map(e=>({lat:e.lat(),lng:e.lng()}))}post_city_data(t){this.getservice.saveCityZone(t).subscribe({next:e=>{console.log(e),e.success===!0&&(console.warn("Sucess updated the data "),this.toaster.success(e.message,"Success Zone"))},error:e=>{if(e.status===401){console.log("DUplicate Error "),this.toaster.error(e.error.message,"Server error");return}this.toaster.error(e.error.message,"Server error"),console.error("Error sending polygon data to server:",e)},complete:()=>{console.log("COMPLETED = sendPolygonDataToServer()"),this.resetMap(),this.selected_city_zone=null,this.selected_city_name=null,this.update_status=!1,this.cityForm.get("mycity").reset(""),this.cityForm.get("city").reset("")}})}showMap(){let t=document.getElementById("map");t&&(t.style.display="block")}isMarkerInsidePolygon(t,e){let o=new google.maps.LatLng(t.lat,t.lng),i=new google.maps.Polygon({paths:e});return google.maps.geometry.poly.containsLocation(o,i)}sendPolygonDataToServer(){if(console.log("**--  >>> zone",this.selected_city_zone),console.log("name",this.selected_city_name),this.update_status===!0&&this.to_update_id){if(console.warn("this.update_status===true && this.selected_city_name"),this.updated_city_zone&&console.warn("UPDATED ZONE",this.updated_city_zone),this.isMarkerInsidePolygon(this.geometry_location,this.updated_city_zone)===!1)return alert("the zone is outside the City "),null;let t=this.updated_city_zone.map(o=>[o.lng(),o.lat()]);t.push(t[0]),console.log("UpdateZoneArray--->",t);let e={_id:this.to_update_id,zone:[t]};return console.log("update_data ->>> ",e),this.post_city_data(e),this.to_update_id=null,null}if(this.selected_city_zone&&this.selected_city_name){if(this.isMarkerInsidePolygon(this.geometry_location,this.selected_city_zone)===!1)return alert("the zone is outside the City "),null;let t=this.selected_city_zone.map(i=>[i.lng(),i.lat()]);t.push(t[0]),console.log("SelectedZoneArray-->>>",t);let e={zone:[t],countryid:this.selected_country_id,city:this.selected_city_name,location:this.geometry_location};console.warn("city_data",e),this.post_city_data(e),console.log(this.selected_city_name);let o={city:this.selected_city_name};return console.log("CURREBT CITY ",o),console.log("this.allcities push",this.allcities),this.allcities.push(o),null}else return this.markFormGroupTouched(this.cityForm),this.toaster.error("Please complete the form ","Empty Field")}onCountrySelect(){let t=this.cityForm.get("country").value,[e,o]=t.split(" ");this.cityForm.get("city").enable(),this.get_selected_cities(o),this.selected_country=e,this.selected_country_id=o,console.warn(t),this.cityForm.get("mycity").reset(""),this.autocompleteCity.setComponentRestrictions({country:this.selected_country}),this.resetMap()}check_existing(t){this.getservice.checkExistingCity(t).subscribe({next:e=>{if(console.log("----------------------------------------------------------------------------"),console.log("SUCCESS CITY CHECK -> 6",e),console.log("----------------------------------------------------------------------------"),this.polygon&&(this.polygon.setMap(null),this.polygon=null),this.map.setZoom(11),e.success===!0){this.buttonName==="Add city"&&this.toggleButtonMode(),this.update_status=!0,this.to_update_id=e.data._id,this.geometry_location=e.data.location,console.log("Allready gemoetry location",this.geometry_location),this.map.setCenter(e.data.location),this.marker=new google.maps.Marker({position:e.data.location,map:this.map});let o=e.data.zone.coordinates[0];console.log("geoJsonCoordinates-->",o);let i=o.map(p=>({lat:p[1],lng:p[0]}));i.pop(),console.log("--------------------------------------------------------"),console.log("polygonCoords CONVERTED",i),console.log("--------------------------------------------------------"),this.draw_existing_polygon(i)}else console.log("+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"),console.log("ELSE this.geometry_location",this.geometry_location),this.map.setCenter(this.geometry_location),this.marker=new google.maps.Marker({position:this.geometry_location,map:this.map}),console.log(),console.log("+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"),this.buttonName==="Update city"&&this.toggleButtonMode(),this.update_status=!1,console.warn("DRAW NEW CITY POLYGON IS CALLED"),this.draw_new_polygon()},error:e=>{console.warn(e),this.toaster.error(e.message,e.statusText)},complete:()=>{console.log("COMPLETED GETING ALREADY EXISTED ZONE ")}})}get_selected_cities(t){this.getservice.get_cities(t).subscribe({next:e=>{if(e.success===!0)if(console.log(e),e.data.length!==0){this.allcities=e.data,console.log("this.allcities",this.allcities);return}else{this.allcities=[];return}this.toaster.error("Server City get Error","Server Error")},error:e=>{console.log("get_selected_cities error",e),this.toaster.error(e.statusText,e.status)},complete:()=>{console.log("Completed get_selected_cities"),this.cityForm.get("mycity").enable()}})}draw_existing_polygon(t){console.log("DRAWING EXISTING MAPP__>");let e=t;this.polygon=new google.maps.Polygon({paths:e,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:4,fillColor:"#FF0000",fillOpacity:.35,editable:!0}),this.updated_city_zone=this.polygon.getPath().getArray(),console.log(),google.maps.event.addListener(this.polygon.getPath(),"set_at",()=>{this.onPolygonChanged(this.polygon,this.updated_city_zone)}),google.maps.event.addListener(this.polygon.getPath(),"insert_at",()=>{this.onPolygonChanged(this.polygon,this.updated_city_zone)}),google.maps.event.addListener(this.polygon.getPath(),"remove_at",()=>{this.onPolygonChanged(this.polygon,this.updated_city_zone)}),this.polygon.setMap(this.map)}onPolygonChanged(t,e){return console.log("this.newpolygon",e),e=t.getPath().getArray(),!0}};n.\u0275fac=function(e){return new(e||n)(d(A),d(k),d(G),d(V))},n.\u0275cmp=E({type:n,selectors:[["app-city"]],standalone:!0,features:[b],decls:24,vars:3,consts:[[1,"container-fluid"],[3,"formGroup"],[1,""],["for","country",1,""],["formControlName","country",1,"form-select",3,"change"],["value","","disabled","true"],[3,"value"],["class","text-danger",4,"ngIf"],["for","city",1,""],["type","text","id","city","formControlName","mycity","placeholder","Enter city name",1,"form-control"],["formControlName","city",1,"form-select",3,"change"],["id","map",1,"m-2",2,"width","100%","height","60vh"],["type","button",1,"btn","btn-dark","form-control",3,"click"],[1,"text-danger"]],template:function(e,o){e&1&&(a(0,"div",0)(1,"form",1)(2,"div",2)(3,"label",3),r(4,"Country:"),s(),a(5,"select",4),m("change",function(){return o.onCountrySelect()}),a(6,"option",5),r(7," Select country "),s(),y(8,Y,2,2,"option",6,W),s(),M(10,j,2,0,"div",7),s(),a(11,"div",2)(12,"label",8),r(13,"City:"),s(),_(14,"input",9),s(),a(15,"div",2)(16,"label",8),r(17,"Already added City List:"),s(),a(18,"select",10),m("change",function(){return o.onallreadySelectCity()}),y(19,$,2,2,"option",6,W),s()(),_(21,"div",11),a(22,"button",12),m("click",function(){return o.sendPolygonDataToServer()}),r(23),s()()()),e&2&&(c(),h("formGroup",o.cityForm),c(7),u(o.countries),c(2),h("ngIf",o.cityForm.get("country").invalid&&o.cityForm.get("country").touched),c(9),u(o.allcities),c(4),w(o.buttonName))},dependencies:[U,O,D,R,T,L,I,N,z,x,B,P,S],styles:["label[_ngcontent-%COMP%]{display:block;margin-bottom:5px;margin-top:10px;font-weight:700;font-size:18px}input[type=text][_ngcontent-%COMP%]:disabled{background-color:#f0f0f0;color:#12b7b7}button[type=submit][_ngcontent-%COMP%]{background-color:#007bff;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:16px}button[type=submit][_ngcontent-%COMP%]:hover{background-color:#0056b3}"]});let l=n;return l})();export{lt as CityComponent};
